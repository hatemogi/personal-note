# 스타웍스 개발기 (3) - 사파리 익스텐션과 웹킷 인젝션

![](starworks/starbucks-captive-01.png)

간단한 개인 프로젝트 개발 과정을 글로 남기고 있습니다. 스타벅스에서 WiFi 연결하는 과정을 편리하게 해주는 macOS 앱을 만들고 있습니다. 제게 필요한 앱이라서 만들고 있는데, 사실 같은 문제를 해결한 "사파리 확장 프로그램"과 "macOS용 앱"이 이미 나와 있습니다. 그래서 아주 새로운 내용은 아니닙니다만, 대신 개발 과정을 상세히 설명하면서 영상과 글로 남기며 진행하고 있으므로, 관련한 공부를 함께 즐기시는 재미는 있으리라 기대해요.

이 프로젝트에 대한 자세한 설명은 앞선 글을 참고해주세요.

* 스타웍스 개발기 (1) - 스타벅스 WiFi 연결러 개발 시작
* 스타웍스 개발기 (2) - 스타벅스 WiFi 연결 과정 분석
* 스타웍스 개발기 (2.5) - 오리지널의 의미

## 스타벅스 WiFi 연결 과정에 끼어들자

이 연재의 (2)편에서 영상으로 스타벅스에서 WiFi에 연결할 때의 내용을 설명드렸습니다. 요약하자면, 스타벅스의 WiFi AP에 붙으면, 처음에는 인터넷 통신이 안되다가, 스타벅스가 원하는 웹페이지(http://first.wifi.olleh.com/으로 시작하는 웹페이지)에서 약관동의 절차를 거치고 나면, 그 당일 인터넷 접근이 가능하다는 내용이었어요.

처음에 정상적인 인터넷 통신이 안되는 상태를 Captive Network에 있다고 얘기하는데요, 이 상태에서는 특정 웹사이트에만 접근할 수 있습니다. 일반 TCP통신은 아예 연결되지 않고, 그 중 HTTP통신의 경우에는 스타벅스 약관 동의에 관련된 웹페이지에만 접근할 수 있습니다. 그 외의 HTTP 접근은, 스타벅스 AP가 가로채서, 가짜 응답을 내보내는데, 이 가짜 응답이 302 Redirect응답이며, 이 응답으로 인해, 우리의 브라우저는 약관 동의 페이지로 자동 이동하게 됩니다.

글로 적으니, 참 복잡해 보입니다만, 유튜브에 올린 영상을 참고해주시면 쉽게 이해가 되실 거라 기대합니다.

이런 방식의 (공개도 아니고 비공개도 아닌) 반공개 네트워크가 꽤 널리 쓰여서인지, 운영체제 차원에서도 이 과정을 지원하며, 브라우저 처럼 생긴 별도의 앱을 띄워서 대신 처리해 줍니다. macOS에는 `Captive Network Assistant.app`라는 이름의 앱이 이 일을 하며, 마치 사파리 브라우저처럼 생겼지만, 매번 깨끗한 상태에서 시작한다는 차이가 있습니다. 쿠키/세션도 남지 않으며, 사파리 익스텐션과도 무관하기에 별로 건드릴 수 있는 일이 없습니다.

그래서 우선 이 `Captive Network Assistant.app`가 뜨는 상황을 막아야 하는데, 간단하게는 터미널에서 시스템 옵션을 하나 꺼주면 됩니다.

``` bash
$ sudo defaults write /Library/Preferences/SystemConfiguration/com.apple.captive.control Active -boolean false
```

이 옵션을 끄면, 더 이상 WiFi연결 과정에서 `Captive Network Assistant.app`이 관여하지 않습니다. 이 옵션을 끄는 방식으로, 기존에 나와있는 사파리/크롬 확장 프로그램과 macOS용 앱이 작동합니다. 두 형태 모두 우선 이 옵션을 꺼야 합니다.

절차가 조금 복잡해 보입니다만, 일단 이 과정으로 사파리 확장 프로그램이든 macOS용 앱이든 그 다음 어떤 처리를 대신 할 수 있게 되는 거지요.

## 사파리(크롬) 확장 프로그램이 하는 일

우선 사파리나 크롬까지 제어권이 이동하면, 그때부터는 확장 프로그램의 영역입니다. 사파리나 크롬 등의 웹브라우저 확장 프로그램 (extension, 익스텐션)이 할 수 있는 일은, 어떤 웹사이트에 접근했을 때, 별도로 준비한 자바스크립트(.js) 코드나 스타일시트(.css)를 첨부하는 것입니다. 크롬의 경우는 어떤지 확인하지 않았습니다만, 사파리의 경우, 특정 사이트의 DOM에는 접근할 수 있는데, 자바스크립트 문맥(context)은 달라서 접근할 수 없습니다. 그래서 별도의 자바스크립트 컨텍스트에서 목표로 한 특정 웹사이트의 DOM엘리먼트들을 건드려서 원하는 처리를 하게 됩니다.


## macOS용 앱이 할 일
