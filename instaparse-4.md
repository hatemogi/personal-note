# 마크다운 파서 만들기 (4) - 마무리 및 회고

> 마크다운 문서를 [Tufte CSS]로 꾸며진 웹 문서로 생성하자는 목표로 프로젝트를 진행하며 총 5편의 글로 개발기를 남겼습니다. 이번 편은, 이 프로젝트의 마무리 글입니다.

[(1) 마크다운 파서를 만들게 된 이유를 나름대로 합리화하고][1], [(2) 인스타파스라는 클로저용 라이브러리를 써서 연습하고][2], [(3) 어둠의 영역에서 헤맨 얘기를 적었다][3]. 그러다 간신히 [(3.5) 희망의 빛줄기를 발견해][3.5] 조금 진척이 있었으나, 그사이 다른 할 일이 있어서 잠시 중단했다가 이제야 마무리했다. 드디어 대망의 마무리.

# 데모 페이지 먼저 봅시다

그간 장황한 과정을 거쳐, Tufte CSS를 위한 마크다운 파서를 직접 만들었다. 그리고 직접 만든 파서를 써서 즉시 변환해 보이는 웹페이지를 만들었다. 잠깐 아래 이미지를 [클릭][demo]해서 직접 써볼 수 있다.

[![](instaparse/thumbnail-lg.png)][demo]

화면 크기에 따라 (반응형 웹!) 왼쪽이나 상단에 온라인 마크다운 에디터가 보이고, 그 에디터 본문을 편집하면, 그 자리에서 바로 Tufte CSS에 맞게 변환된 HTML페이지가 우측이나 하단에 보인다. 오우 예~!

참고로, 이 데모는 마크다운 문법의 일부와 [Tufte CSS]를 위한 측주 문법을 지원한다. 실험적인 코드라서 일반적인 용도로 실용하기에는 아직 부족하다.

이하, 위 데모 페이지를 만들면서 배우고 느낀 점을 정리해보자.

# 어려웠던 문제

과연 CFG/PEG 파서로 마크다운 텍스트를 잘 분석할 수 있을지 불확실한 상태에서 [헤매이다][3], 두 번에 걸쳐 처리하면 되겠다는 생각이 떠올랐다.

![](instaparse/break-through.png)

마크다운 텍스트의 주요 골격(문단)을 먼저 쪼개놓고, 문단의 내용을 다시 분석하는 방법이다.

![](instaparse/step2.png)

논리적으로 두번에 걸쳐 처리하자, 결국 원하는 형태로 분석해낼 수 있었다.

# 데모 페이지를 만들다가 만난 문제

아무튼, 라이브 에디팅으로 보여주는 데모 페이지는 화면을 반으로 나눠서, 한쪽에 [CodeMirror]로 온라인 텍스트 에디터를 붙였고, 다른 한쪽에 곧바로 변환 결과를 보여주는 화면을 준비했다. 텍스트 에디터의 내용이 바뀔 때마다, 개발한 마크다운 파서를 돌려서 HTML을 얻어내서 원래 페이지의 내용을 교체해서 보이고자 했다.

글자를 입력하면 곧바로 화면에 반영된 내용이 보였으면 좋겠다고 욕심을 부렸다. 처음 작성한 파서의 성능이 충분히 빠르지 못해서, `keyDown/keyUp` 이벤트에 분석 처리를 넣었더니, 에디터를 편집하기에 거북할 정도로 느렸다.

사실 내가 원한 '라이브 에디팅'이라는 게, 반드시 곧바로 정확히 반영돼야 하는 것은 아니고, 1초 남짓한 시간 안에 최종본이 반영돼 보이면 된다. 처음에 데모 페이지에 첨부한 텍스트 기준으로 1초 남짓 분석 시간이 걸렸다. 이 정도면 한번 분석에 필요한 시간은 참을만한 정도인데, 매 키입력시마다 분석을 하기에는 너무 느렸다.

그래서, 텍스트를 빠르게 입력하면 중간은 여러번 건너 뛰고, 마지막 내용에 대해서만 분석하는 방법을 노렸다. 그 정도면 데모에서 보일만한 성능 수준은 될 것 같다.

# 웹워커

![](instaparse/webworkers.png)

# Tufte CSS를 적용해 본 느낌

# 개발하며 배운점

* 클로저와 클로저스크립트는 참 훌륭하다.
* [인스타파스] 라이브러리도 참 아름답다.
* PEG 파서 생성기는 나중에도 요긴히 쓸 일이 있겠다.
* 텍스트 분석 과정을 두 번 이상 나화와 사눠서 처리하니 편리했다.
* 자바스크립트 환경에서도 [웹워커(Web Workers)][WebWorkers]로 백그라운드 스레드를 쓸 수 있다.

# 결론

마크다운의 문법을 조금 확장해서, Tufte CSS의 측주를 표현하는 파서를 만들어 봤다. 실험적으로 만들었고, 기본적인 처리에 측추 처리를 덧붙인 것에 불과하지만, 나머지 Tufte CSS를 위한 처리도 어렵지 않게 구현할 수 있을 것으로 보인다. 그리고, 그 과정에서 배운 'PEG-style 파서 생성기'와 '웹워커'도 언젠가 유용하게 쓸 수 있을 것 같다.

# 회고

간단하게 넘어갈 일을, 참 멀게 돌아서 실험해보는 일을 저질렀다. 종종 사이드 프로젝트를 진행하는 일은 좋은 일이지만, 이렇게 너무 많은 시간을 할애하게 되면 다소 지겨워지기도 한다.

# 관련글

* [(1) 합리화와 사전조사][1]
* [(2) 인스타파스 연습][2]
* [(3) 어둠의 영역][3]
* [(3.5) 빛의 놀이중][3.5]

[Tufte CSS]: http://edwardtufte.github.io/tufte-css/
[인스타파스]: https://github.com/Engelberg/instaparse
[WebWorkers]: https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers
[1]: https://medium.com/happyprogrammer-in-jeju/마크다운-파서-만들기-1-합리화와-사전조사-932a269b7233
[2]: https://medium.com/happyprogrammer-in-jeju/마크다운-파서-만들기-2-인스타파서-연습-12b2291a9f8b
[3]: https://medium.com/happyprogrammer-in-jeju/마크다운-파서-만들기-3-어둠의-영역-be10d140e6b9
[3.5]: https://medium.com/happyprogrammer-in-jeju/마크다운-파서-만들기-3-5-빛의-놀이-중-8e5c5c20f7e3
[demo]: http://hatemogi.github.io/tufdown
